name: preview
on:
  pull_request:
    types: [ labeled ]
jobs:
  container-job: 
    runs-on: ubuntu-latest
    container: gradle:jdk16-hotspot
      ports: 
	- 8080:8080

    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432

    steps:
      - name: Public IP
        id: ip
        uses: haythem/public-ip@v1.2

      - name: Print Public IP
        run: |
          echo ${{ steps.ip.outputs.ipv4 }}
          echo ${{ steps.ip.outputs.ipv6 }}

      - name: Checkout out repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get postgresql, git, docker
        run: |
           apt-get update && apt-get install postgresql-client git -y

      - name: Initialize database
        run: psql -h postgres -p 5432 -U postgres < .docker/initdb.sql
        env:
          PGPASSWORD: postgres

      - name: run
        run: ./gradlew run
        env:
          MOLGENIS_POSTGRES_USER: molgenis_admin
          MOLGENIS_POSTGRES_PASS: molgenis_admin
          MOLGENIS_POSTGRES_URI: jdbc:postgresql://postgres/molgenisdb
          JVM_OPTS: -Xmx3200m
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
