sequenceDiagram

    participant Controller as Head Node Controller
    participant Workers as Workers API
    participant Jobs as Jobs API
    participant Slurm as Slurm Controller
    participant Workload as Workload (Container or Wrapper)
    participant Artifact as Artifact API
    participant SharedFS as Shared Filesystem
    participant DB as System Database

    Note over Controller,DB: Phase 1: Registration & Job Acquisition

    Controller->>Workers: POST /workers/register (signed, X-Trace-Id)
    Workers->>DB: persist worker + capabilities
    Workers-->>Controller: 200 OK

    Controller->>Jobs: GET /jobs?status=pending&worker_id=HPC01 (signed)
    Jobs-->>Controller: [{job_id, processor, profile, inputs[], _links: {claim}}]

    Controller->>Jobs: POST /jobs/{job_id}/claim (signed)
    Jobs->>DB: atomically mark CLAIMED
    Jobs-->>Controller: {job, _links: {submit, cancel}}

    Note over Controller,DB: Phase 2: Input Staging & Slurm Submission

    alt Input artifacts present
        alt residence = posix
            Controller->>SharedFS: symlink file:// path into input_dir
        else residence = managed
            Controller->>Artifact: GET /artifacts/{id}/files/{path}
            Artifact-->>Controller: file bytes
            Controller->>SharedFS: write to input_dir
        end
        Controller->>Controller: verify SHA-256
    end

    Controller->>Slurm: sbatch (container or wrapper script)
    Slurm-->>Controller: slurm_job_id

    Controller->>Jobs: POST /jobs/{job_id}/transitions {SUBMITTED, slurm_job_id}
    Jobs->>DB: persist transition + update status
    Jobs-->>Controller: 201 Created {transition, job: {_links: {start, cancel}}}

    Note over Controller,DB: Phase 3: Execution & Monitoring

    Slurm->>Workload: dispatch to compute node

    loop Daemon monitor loop (poll interval)
        Controller->>Slurm: squeue/sacct (check job state)
        Slurm-->>Controller: RUNNING | COMPLETED | FAILED | ...

        alt State changed to RUNNING (first time)
            Controller->>Jobs: POST /jobs/{job_id}/transitions {STARTED}
            Jobs->>DB: persist transition + update status
        end

        opt .hpc_progress.json exists in output_dir
            Controller->>SharedFS: read .hpc_progress.json
            SharedFS-->>Controller: {phase, message, progress}
            Controller->>Jobs: POST /jobs/{job_id}/transitions {STARTED, detail: progress}
        end
    end

    Workload->>SharedFS: write results to output_dir
    opt Progress reporting
        Workload->>SharedFS: write .hpc_progress.json
    end

    Note over Controller,DB: Phase 4: Output & Completion

    alt Slurm reports COMPLETED
        alt residence = posix
            Controller->>Artifact: POST /artifacts {type, residence: posix, content_url: file://...}
            Controller->>Artifact: POST /artifacts/{id}/commit {sha256, size_bytes}
        else residence = managed
            Controller->>Artifact: POST /artifacts {type, residence: managed}
            Controller->>Artifact: PUT /artifacts/{id}/files/{path}
            Controller->>Artifact: POST /artifacts/{id}/commit {sha256, size_bytes}
        end

        Controller->>Jobs: POST /jobs/{job_id}/transitions {COMPLETED, output_artifact_id}
        Jobs->>DB: persist transition + update status
        Jobs-->>Controller: 201 Created
    else Slurm reports FAILED / TIMEOUT / CANCELLED
        Controller->>Jobs: POST /jobs/{job_id}/transitions {FAILED, detail}
        Jobs->>DB: persist transition + update status
    end
