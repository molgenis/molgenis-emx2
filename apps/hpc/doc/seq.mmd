sequenceDiagram
  participant Controller as Head Node Controller
  participant Workers as Workers API
  participant Jobs as Jobs API
  participant Slurm as Slurm Controller
  participant Workload as Workload (Container/Wrapper)
  participant SharedFS as Shared FS (staging + logs + outputs)
  participant Artifact as Artifact API
  participant DB as System DB

  Note over Controller,DB: 1) Register + claim
  Controller->>Workers: POST /workers/register (signed)
  Workers->>DB: persist worker + capabilities
  Workers-->>Controller: 200 OK

  Controller->>Jobs: GET /jobs?status=pending (signed)
  Jobs-->>Controller: jobs + claim link
  Controller->>Jobs: POST /jobs/{id}/claim (signed)
  Jobs->>DB: atomically mark CLAIMED
  Jobs-->>Controller: job + submit link

  Note over Controller,DB: 2) Stage inputs + submit
  opt Inputs required
    Controller->>SharedFS: stage inputs into input_dir\n(posix link OR download from Artifact)
    opt If managed artifacts
      Controller->>Artifact: GET /artifacts/{id}/files/{path}
      Artifact-->>Controller: bytes
      Controller->>SharedFS: write into input_dir
    end
    Controller->>Controller: verify SHA-256
  end

  Controller->>Slurm: sbatch workload (wrapper/container)
  Slurm-->>Controller: slurm_job_id
  Controller->>Jobs: POST transition SUBMITTED (slurm_job_id)
  Jobs->>DB: persist transition + update status

  Note over Controller,DB: 3) Execute + monitor
  Slurm->>Workload: dispatch to compute node
  Workload->>SharedFS: write logs + outputs to output_dir

  loop poll
    Controller->>Slurm: squeue/sacct
    Slurm-->>Controller: RUNNING | COMPLETED | FAILED | ...
    opt state change
      Controller->>Jobs: POST transition (STARTED/...)
      Jobs->>DB: persist transition + update status
    end
    opt progress file present
      Controller->>SharedFS: read .hpc_progress.json
      SharedFS-->>Controller: progress payload
      Controller->>Jobs: POST transition (detail: progress)
      Jobs->>DB: persist transition + update status
    end
  end

  Note over Controller,DB: 4) Upload from SharedFS + complete
  opt Upload logs (from SharedFS)
    Controller->>Artifact: PUT /artifacts/{logs}/files/... (read from output_dir)
    Controller->>Artifact: POST /artifacts/{logs}/commit
  end

  alt Slurm COMPLETED
    Controller->>Artifact: create/commit output artifact\n(posix url OR managed upload from SharedFS)
    Controller->>Jobs: POST transition COMPLETED (output_artifact_id)
    Jobs->>DB: persist transition + update status
  else Slurm FAILED/TIMEOUT/CANCELLED
    Controller->>Jobs: POST transition FAILED (detail)
    Jobs->>DB: persist transition + update status
  end