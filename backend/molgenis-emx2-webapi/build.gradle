plugins {
    id "com.avast.gradle.docker-compose" version "0.17.20"
}

dependencies {
    implementation project(':backend:molgenis-emx2-sql')
    implementation project(':backend:molgenis-emx2-io')
    implementation project(':backend:molgenis-emx2-graphql')
    implementation project(':backend:molgenis-emx2')
    implementation project(':backend:molgenis-emx2-datamodels')
    implementation project(':backend:molgenis-emx2-rdf')
    implementation project(':backend:molgenis-emx2-beacon-v2')
    implementation project(':backend:molgenis-emx2-cafevariome')
    implementation project(':backend:molgenis-emx2-fairdatapoint')
    implementation project(':backend:molgenis-emx2-tasks')
    implementation project(':backend:molgenis-emx2-email')
    implementation project(':backend:molgenis-emx2-analytics')
    implementation 'io.swagger.parser.v3:swagger-parser:2.1.22'
    implementation 'com.squareup.okhttp3:okhttp:4.11.0'
    implementation 'com.squareup.okhttp3:okhttp-brotli:4.11.0'
    testImplementation 'io.rest-assured:rest-assured:5.3.2'
    testImplementation 'org.apache.poi:poi:4.1.2'
    testImplementation 'org.apache.poi:poi-ooxml:4.1.2'
    testImplementation 'net.lingala.zip4j:zip4j:2.11.5'
    testImplementation 'uk.org.webcompere:system-stubs-jupiter:2.1.8'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.3'
    implementation 'com.github.dfabulich:sitemapgen4j:1.1.2'
    implementation 'de.larsgrefer.sass:sass-embedded-host:1.15.4'
    implementation 'com.github.ben-manes.caffeine:caffeine:3.2.1'

    implementation 'io.prometheus:prometheus-metrics-core:1.4.1'
    implementation 'io.prometheus:prometheus-metrics-instrumentation-jvm:1.4.1'
    implementation 'io.prometheus:prometheus-metrics-exporter-httpserver:1.4.1'
    implementation 'io.prometheus:prometheus-metrics-exporter-servlet-jakarta:1.4.1'


}

task dev(type: JavaExec) {
    group = 'application'
    classpath = sourceSets.main.runtimeClasspath
    main = 'org.molgenis.emx2.RunMolgenisEmx2'
}

tasks.register('testStarterKit', Test) {
    jvmArgs("--add-opens=java.base/java.util=ALL-UNNAMED", "--add-opens=java.base/java.lang=ALL-UNNAMED", "-XX:+EnableDynamicAgentLoading")
    useJUnitPlatform {
        includeTags "starter-kit"
    }
    testLogging {
        events "passed", "skipped", "failed" //, "standardOut", "standardError"

        showExceptions true
        exceptionFormat "full"
        showCauses true
        showStackTraces true

        showStandardStreams = false
    }
}

dockerCompose {
    useComposeFiles = ['../../docker-compose.yml'] // Docker-compose in project root
    isRequiredBy(tasks.named('testStarterKit'))
    removeVolumes = false
    captureContainersOutput = true // Log container output for CI debugging
    projectName = "emx2-starterkit-tests"
}

