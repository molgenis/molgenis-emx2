# Gradle
# Build your Java project and run tests with Gradle using a Gradle wrapper script.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

#trigger only on master or PR to master
trigger:
- master
pr:
  - master

resources:
  containers:
  - container: postgres
    image: postgres:14-alpine
    env:
      POSTGRES_PASSWORD: postgres
    ports:
      - 5432:5432

services:
  postgres: postgres

steps:
- script: |
    wget -O - https://packages.adoptium.net/artifactory/api/gpg/key/public | sudo apt-key add -
    echo "deb https://packages.adoptium.net/artifactory/deb $(awk -F= '/^VERSION_CODENAME/{print$2}' /etc/os-release) main" | sudo tee /etc/apt/sources.list.d/adoptium.list
    sudo apt install temurin-17-jdk
    java -version
  displayName: get postgresql client
- script: |
    psql -h localhost -p 5432 -U postgres < .docker/initdb.sql
  displayName: initialize database
  env:
    PGPASSWORD: postgres\
- script: |
    java --version
    ./gradlew test
  displayName: run test
   
  env:
    MOLGENIS_POSTGRES_USER: molgenis
    MOLGENIS_POSTGRES_PASS: molgenis
    MOLGENIS_POSTGRES_URI: jdbc:postgresql://localhost/molgenis
    JVM_OPTS: -Xmx3200m
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"